pipeline {
  agent {
    docker {
      image 'maven:3.6.3-jdk-11'
      args  '-e DOCKER_HOST=${DOCKER_HOST} -u root --tmpfs /tmp:rw,exec,size=1g --tmpfs /root/.m2:rw,exec,size=1g --tmpfs ${WORKSPACE},size=4g'
    }
  }

  options {
    timeout(time: 4, unit: 'HOURS')
  }

  stages {
    stage('Check compilation') {
      steps {
        sh 'mvn clean package -Dmaven.repo.local=${WORKSPACE}-${BUILD_NUMBER} -DskipTests -T1C'
        sh 'ls -l $WORKSPACE-$BUILD_NUMBER'
      }
    }
    stage('Unit & integration tests') {
      steps {
        sh 'ls -l $WORKSPACE-$BUILD_NUMBER'
        sh 'mvn package verify -Dmaven.repo.local=${WORKSPACE}-${BUILD_NUMBER}'
        sh 'ls -l $WORKSPACE-$BUILD_NUMBER'
      }
    }
  }
  post {
    success {
//      junit '**/target/surefire-reports/*.xml'
      mail to: 'aduprat@linagora.com',
        from: 'jenkins@ci-james.linagora.com',
        subject: "Succedded Pipeline: ${currentBuild.fullDisplayName}",
        body: "The following job has succedded ${env.BUILD_URL}"
    }
    failure {
      mail to: 'aduprat@linagora.com',
        from: 'jenkins@ci-james.linagora.com',
        subject: "Failed Pipeline: ${currentBuild.fullDisplayName}",
        body: "Something is wrong with ${env.BUILD_URL}"
    }
  }
}
